<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Qu·∫£n l√Ω T·ª´ v·ª±ng</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background-color: #f4f7f9; color: #333; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; background: #fff; padding: 30px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #667eea; margin-bottom: 20px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; font-weight: 600; margin-bottom: 5px; }
        input[type="text"] { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px; font-size: 16px; }
        button { padding: 12px 25px; border: none; border-radius: 8px; background: #667eea; color: white; font-size: 16px; font-weight: bold; cursor: pointer; transition: background 0.3s; }
        button:hover { background: #5a66d4; }
        #message { margin-top: 20px; padding: 15px; border-radius: 8px; text-align: center; display: none; }
        .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px; border: 1px solid #ddd; text-align: left; }
        th { background-color: #667eea; color: white; }
        tr:nth-child(even) { background-color: #f9f9f9; }
        .action-buttons button { padding: 5px 10px; font-size: 14px; margin-right: 5px; background: #667eea; }
        .action-buttons button.delete { background: #d9534f; }
        .search-container { display: flex; gap: 10px; margin-bottom: 20px; }
        .search-container input { flex: 1; }
        .button-group { display: flex; gap: 10px; margin-top: 15px; }
        .list-section { margin-top: 20px; }
        .list-item { display: flex; gap: 10px; align-items: center; margin-bottom: 5px; }
        .list-item input { flex: 1; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üõ†Ô∏è Qu·∫£n l√Ω T·ª´ v·ª±ng & C√¢u</h1>
        <form id="word-form">
            <div class="form-group">
                <label for="hanzi">Ch·ªØ H√°n ch√≠nh:</label>
                <input type="text" id="hanzi" placeholder="Nh·∫≠p ch·ªØ H√°n c·ªßa t·ª´ v·ª±ng (v√≠ d·ª•: Â≠¶)" required>
            </div>
            <div class="form-group">
                <label for="hanviet">H√°n Vi·ªát:</label>
                <input type="text" id="hanviet" placeholder="H√°n Vi·ªát (v√≠ d·ª•: H·ªçc)">
            </div>
            
            <div class="list-section">
                <h3>T·ª´ v·ª±ng li√™n quan</h3>
                <div id="words-list">
                    <div class="list-item">
                        <input type="text" class="word-chinese" placeholder="T·ª´ v·ª±ng ti·∫øng Trung">
                        <input type="text" class="word-vietnamese" placeholder="Nghƒ©a ti·∫øng Vi·ªát">
                        <input type="text" class="word-category" placeholder="Ph√¢n lo·∫°i (c√°ch nhau b·ªüi d·∫•u ph·∫©y)">
                        <button type="button" class="remove-btn">-</button>
                    </div>
                </div>
                <button type="button" id="add-word-btn">Th√™m t·ª´ v·ª±ng m·ªõi</button>
            </div>

            <div class="list-section">
                <h3>V√≠ d·ª• c√¢u</h3>
                <div id="sentences-list">
                    <div class="list-item">
                        <input type="text" class="sentence-chinese" placeholder="C√¢u ti·∫øng Trung">
                        <input type="text" class="sentence-vietnamese" placeholder="Nghƒ©a ti·∫øng Vi·ªát">
                        <input type="text" class="sentence-category" placeholder="Ph√¢n lo·∫°i (c√°ch nhau b·ªüi d·∫•u ph·∫©y)">
                        <button type="button" class="remove-btn">-</button>
                    </div>
                </div>
                <button type="button" id="add-sentence-btn">Th√™m c√¢u m·ªõi</button>
            </div>

            <div class="button-group">
                <button type="submit">Th√™m / C·∫≠p nh·∫≠t</button>
                <button type="button" onclick="clearForm()">L√†m m·ªõi</button>
            </div>
        </form>
        <div id="message"></div>
        
        <h2>Danh s√°ch t·ª´ v·ª±ng</h2>
        <div class="search-container">
            <input type="text" id="search-input" placeholder="T√¨m ki·∫øm t·ª´ v·ª±ng ƒë·ªÉ s·ª≠a">
            <button id="search-btn">T√¨m ki·∫øm</button>
        </div>
        <table id="vocab-table">
            <thead>
                <tr>
                    <th>Ch·ªØ H√°n</th>
                    <th>H√°n Vi·ªát</th>
                    <th>T·ª´ v·ª±ng</th>
                    <th>H√†nh ƒë·ªông</th>
                </tr>
            </thead>
            <tbody>
                </tbody>
        </table>
    </div>

    <script>
        const form = document.getElementById('word-form');
        const messageDiv = document.getElementById('message');
        const vocabTableBody = document.querySelector('#vocab-table tbody');
        const wordsList = document.getElementById('words-list');
        const sentencesList = document.getElementById('sentences-list');
        let fullData = null;

        function normalizeString(str) {
            if (!str) return '';
            return str.toLowerCase()
                      .normalize('NFD')
                      .replace(/[\u0300-\u036f]/g, "")
                      .replace(/ƒë/g, 'd').replace(/ƒê/g, 'D');
        }

        async function loadData() {
            try {
                const response = await fetch('tuvung1.json');
                if (!response.ok) throw new Error('Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu t·ª´ v·ª±ng.');
                fullData = await response.json();
                renderTable(fullData);
            } catch (error) {
                showMessage('L·ªói: ' + error.message, 'error');
            }
        }

        function renderTable(data) {
            vocabTableBody.innerHTML = '';
            const sortedKeys = Object.keys(data).sort();
            for (const hanzi of sortedKeys) {
                const entry = data[hanzi];
                const words = entry.words ? entry.words.map(w => w.chinese).join(', ') : '';
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${hanzi}</td>
                    <td>${entry.hanviet || ''}</td>
                    <td>${words}</td>
                    <td class="action-buttons">
                        <button onclick="editEntry('${hanzi}')">S·ª≠a</button>
                        <button class="delete" onclick="deleteEntry('${hanzi}')">X√≥a</button>
                    </td>
                `;
                vocabTableBody.appendChild(row);
            }
        }

        function addInputRow(list, type) {
            const newItem = document.createElement('div');
            newItem.className = 'list-item';
            const chinesePlaceholder = type === 'word' ? 'T·ª´ v·ª±ng ti·∫øng Trung' : 'C√¢u ti·∫øng Trung';
            const vietnamesePlaceholder = type === 'word' ? 'Nghƒ©a ti·∫øng Vi·ªát' : 'Nghƒ©a ti·∫øng Vi·ªát';
            const categoryPlaceholder = 'Ph√¢n lo·∫°i (c√°ch nhau b·ªüi d·∫•u ph·∫©y)';
            newItem.innerHTML = `
                <input type="text" class="${type}-chinese" placeholder="${chinesePlaceholder}">
                <input type="text" class="${type}-vietnamese" placeholder="${vietnamesePlaceholder}">
                <input type="text" class="${type}-category" placeholder="${categoryPlaceholder}">
                <button type="button" class="remove-btn">-</button>
            `;
            list.appendChild(newItem);
            newItem.querySelector('.remove-btn').addEventListener('click', () => newItem.remove());
        }

        document.getElementById('add-word-btn').addEventListener('click', () => addInputRow(wordsList, 'word'));
        document.getElementById('add-sentence-btn').addEventListener('click', () => addInputRow(sentencesList, 'sentence'));

        async function editEntry(hanzi) {
            if (!fullData || !fullData[hanzi]) return;
            
            clearForm();
            
            const entry = fullData[hanzi];
            document.getElementById('hanzi').value = hanzi;
            document.getElementById('hanviet').value = entry.hanviet || '';
            document.getElementById('hanzi').readOnly = true;
            document.getElementById('hanzi').style.backgroundColor = '#e9ecef';
            
            // Populate words
            wordsList.innerHTML = '';
            (entry.words || []).forEach(word => {
                addInputRow(wordsList, 'word');
                const lastItem = wordsList.lastElementChild;
                lastItem.querySelector('.word-chinese').value = word.chinese;
                lastItem.querySelector('.word-vietnamese').value = word.meaning;
                lastItem.querySelector('.word-category').value = (word.category || []).join(', ');
            });

            // Populate sentences
            sentencesList.innerHTML = '';
            (entry.sentences || []).forEach(sentence => {
                addInputRow(sentencesList, 'sentence');
                const lastItem = sentencesList.lastElementChild;
                lastItem.querySelector('.sentence-chinese').value = sentence.chinese;
                lastItem.querySelector('.sentence-vietnamese').value = sentence.vietnamese;
                lastItem.querySelector('.sentence-category').value = (sentence.category || []).join(', ');
            });

            showMessage('ƒêang ch·ªânh s·ª≠a t·ª´ "' + hanzi + '". Vui l√≤ng ch·ªânh s·ª≠a v√† ·∫•n "C·∫≠p nh·∫≠t".', 'success');
        }

        function clearForm() {
            form.reset();
            document.getElementById('hanzi').readOnly = false;
            document.getElementById('hanzi').style.backgroundColor = '#fff';
            document.getElementById('message').style.display = 'none';
            
            // Clear all dynamically added rows
            wordsList.innerHTML = '';
            sentencesList.innerHTML = '';
            addInputRow(wordsList, 'word');
            addInputRow(sentencesList, 'sentence');
        }
        
        form.addEventListener('submit', async function(event) {
            event.preventDefault();
            const hanzi = document.getElementById('hanzi').value;
            const hanviet = document.getElementById('hanviet').value;
            
            const words = Array.from(wordsList.querySelectorAll('.list-item')).map(item => {
                const chinese = item.querySelector('.word-chinese').value;
                const meaning = item.querySelector('.word-vietnamese').value;
                const category = item.querySelector('.word-category').value.split(',').map(s => s.trim()).filter(s => s);
                return { chinese, meaning, category };
            }).filter(word => word.chinese);

            const sentences = Array.from(sentencesList.querySelectorAll('.list-item')).map(item => {
                const chinese = item.querySelector('.sentence-chinese').value;
                const vietnamese = item.querySelector('.sentence-vietnamese').value;
                const category = item.querySelector('.sentence-category').value.split(',').map(s => s.trim()).filter(s => s);
                return { chinese, vietnamese, category };
            }).filter(sentence => sentence.chinese);

            const newData = { hanviet, words, sentences };
            
            // Frontend validation for empty fields
            if (!hanzi.trim()) {
                showMessage('L·ªói: Ch·ªØ H√°n kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng.', 'error');
                return;
            }

            // MOCK: This part still needs a backend to save data.
            showMessage('D·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c t·∫°o. B·∫°n c·∫ßn m·ªôt server ƒë·ªÉ l∆∞u thay ƒë·ªïi v√†o file JSON.', 'error');
            console.log('D·ªØ li·ªáu c·∫ßn g·ª≠i:', { [hanzi]: newData });
        });
        
        document.getElementById('search-btn').addEventListener('click', () => {
            const query = normalizeString(document.getElementById('search-input').value.trim());
            if (!query) {
                renderTable(fullData);
                return;
            }

            const filteredData = {};
            for (const hanzi in fullData) {
                const entry = fullData[hanzi];
                let match = false;
                
                if (hanzi.includes(query) || (entry.hanviet && normalizeString(entry.hanviet).includes(query))) match = true;
                
                if (entry.words) {
                    for (const word of entry.words) {
                        if (word.chinese.includes(query) || normalizeString(word.meaning).includes(query)) {
                            match = true;
                            break;
                        }
                    }
                }

                if (entry.sentences) {
                    for (const sentence of entry.sentences) {
                        if (sentence.chinese.includes(query) || normalizeString(sentence.vietnamese).includes(query)) {
                            match = true;
                            break;
                        }
                    }
                }

                if (match) {
                    filteredData[hanzi] = entry;
                }
            }
            renderTable(filteredData);
        });

        function showMessage(msg, type) {
            messageDiv.textContent = msg;
            messageDiv.className = '';
            messageDiv.classList.add(type);
            messageDiv.style.display = 'block';
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            // Initial call to set up the first row
            addInputRow(wordsList, 'word');
            addInputRow(sentencesList, 'sentence');
        });
    </script>
</body>
</html>
