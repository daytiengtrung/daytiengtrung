<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Panel - Qu·∫£n l√Ω T·ª´ v·ª±ng</title>
  <style>
    body { font-family: system-ui, Arial, sans-serif; background:#f5f7fb; margin:0; padding:24px; }
    .container { max-width: 980px; margin:auto; background:#fff; border-radius:14px; padding:20px 24px; box-shadow:0 8px 24px rgba(0,0,0,.08); }
    h1 { margin: 0 0 16px; color:#2a5bd7; font-size:24px; }
    h2 { margin-top: 24px; font-size:18px; }
    label { display:block; margin-top:12px; font-weight:600; }
    input[type="text"], input[type="file"], textarea { width:100%; box-sizing:border-box; padding:10px 12px; border:1px solid #dfe3eb; border-radius:10px; outline:none; }
    input[type="text"]:focus, textarea:focus { border-color:#2a5bd7; }
    button { border:0; border-radius:10px; background:#2a5bd7; color:#fff; padding:10px 14px; cursor:pointer; }
    button[disabled] { background:#a3b5ee; cursor:not-allowed; }
    .row { display:flex; gap:10px; align-items:center; }
    .row > * { flex: 1; }
    .hint { color:#666; font-size:12px; margin-top:4px; }
    #message { display:none; margin-top:12px; padding:10px 12px; border-radius:10px; }
    #message.success { background:#e8f7ee; color:#146c43; }
    #message.error { background:#fde7ea; color:#b42318; }
    table { width:100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border:1px solid #e9edf4; padding:8px 10px; text-align:left; vertical-align:top; }
    th { background:#f1f4fb; }
    .list-item { display:flex; gap:6px; margin:6px 0; }
    .list-item input { flex:1; }
    .pill { display:inline-block; padding:2px 8px; border-radius:999px; background:#f1f4fb; font-size:12px; color:#2a5bd7; margin-left:6px; }
    .danger { background:#e03b3b !important; }
    .muted { background:#eef2ff !important; color:#7180c5 !important; }
  </style>
</head>
<body>
  <div class="container">
    <h1>üõ†Ô∏è Qu·∫£n l√Ω T·ª´ v·ª±ng & C√¢u</h1>

    <div>
      <label>Nh·∫≠p file JSON t·ª´ m√°y</label>
      <input type="file" id="jsonFile" accept=".json" />
    </div>

    <div>
      <label>Nh·∫≠p JSON t·ª´ URL</label>
      <div class="row">
        <input type="text" id="jsonUrl" placeholder="https://.../tuvung.json (link ph·∫£i cho ph√©p CORS)" />
        <button id="loadUrlBtn" type="button">T·∫£i t·ª´ URL</button>
      </div>
      <div class="hint">G·ª£i √Ω: d√πng GitHub Raw, Vercel, Netlify‚Ä¶ N·∫øu b·ªã l·ªói CORS, b·∫°n c·∫ßn host file ·ªü n∆°i cho ph√©p truy c·∫≠p tr·ª±c ti·∫øp.</div>
    </div>

    <div id="message"></div>

    <form id="word-form" style="margin-top:12px;">
      <label>Ch·ªØ H√°n</label>
      <input type="text" id="hanzi" placeholder="V√≠ d·ª•: Â≠¶" required />

      <label>H√°n Vi·ªát</label>
      <input type="text" id="hanviet" placeholder="V√≠ d·ª•: H·ªçc" />

      <h2>T·ª´ v·ª±ng li√™n quan</h2>
      <div id="words-list"></div>
      <button type="button" id="addWordBtn">+ Th√™m t·ª´ v·ª±ng</button>

      <h2>V√≠ d·ª• c√¢u</h2>
      <div id="sentences-list"></div>
      <button type="button" id="addSentenceBtn">+ Th√™m c√¢u</button>

      <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:12px;">
        <button type="submit">üíæ L∆∞u</button>
        <button type="button" id="clearBtn">L√†m m·ªõi</button>
        <button type="button" id="exportBtn">‚¨áÔ∏è Xu·∫•t JSON</button>
      </div>
    </form>

    <h2>Danh s√°ch t·ª´ v·ª±ng</h2>
    <div class="row">
      <input type="text" id="searchInput" placeholder="T√¨m theo ch·ªØ H√°n / H√°n Vi·ªát / nghƒ©a / c√¢u..." />
      <button id="searchBtn" type="button">T√¨m</button>
      <button id="resetSearchBtn" type="button" class="muted">Reset</button>
    </div>
    <div class="hint">C√°c m·ª•c c√≥ <span class="pill">CSDL g·ªëc</span> l√† d·ªØ li·ªáu b·∫£o v·ªá: <b>kh√¥ng th·ªÉ x√≥a</b>.</div>

    <table>
      <thead>
        <tr>
          <th>Ch·ªØ H√°n</th>
          <th>H√°n Vi·ªát</th>
          <th>T·ª´ v·ª±ng</th>
          <th>H√†nh ƒë·ªông</th>
        </tr>
      </thead>
      <tbody id="vocabTable"></tbody>
    </table>
  </div>

<script>
let fullData = {};               // D·ªØ li·ªáu hi·ªán t·∫°i
let protectedKeys = new Set();   // C√°c ch·ªØ H√°n thu·ªôc CSDL g·ªëc (kh√¥ng cho x√≥a)

const vocabTableBody = document.getElementById('vocabTable');
const wordsList = document.getElementById('words-list');
const sentencesList = document.getElementById('sentences-list');
const messageDiv = document.getElementById('message');

function showMessage(msg, type='success') {
  messageDiv.textContent = msg;
  messageDiv.className = type === 'success' ? 'success' : 'error';
  messageDiv.id = 'message'; // keep id
  messageDiv.style.display = 'block';
  setTimeout(()=>{ messageDiv.style.display = 'none'; }, 4000);
}

function saveProtectedToLS() {
  localStorage.setItem('protectedKeys', JSON.stringify(Array.from(protectedKeys)));
}
function loadProtectedFromLS() {
  const raw = localStorage.getItem('protectedKeys');
  if (raw) {
    try { protectedKeys = new Set(JSON.parse(raw)); }
    catch { protectedKeys = new Set(); }
  }
}

function addInputRow(list, type) {
  const wrapper = document.createElement('div');
  wrapper.className = 'list-item';
  wrapper.innerHTML = `
    <input type="text" class="${type}-chinese" placeholder="${type==='word' ? 'T·ª´ v·ª±ng ti·∫øng Trung' : 'C√¢u ti·∫øng Trung'}" />
    <input type="text" class="${type}-vietnamese" placeholder="${type==='word' ? 'Nghƒ©a ti·∫øng Vi·ªát' : 'D·ªãch ti·∫øng Vi·ªát'}" />
    <input type="text" class="${type}-category" placeholder="Ph√¢n lo·∫°i (c√°ch nhau b·ªüi d·∫•u ph·∫©y)" />
    <button type="button" onclick="this.parentNode.remove()">-</button>
  `;
  list.appendChild(wrapper);
}

document.getElementById('addWordBtn').onclick = ()=> addInputRow(wordsList, 'word');
document.getElementById('addSentenceBtn').onclick = ()=> addInputRow(sentencesList, 'sentence');
document.getElementById('clearBtn').onclick = clearForm;
document.getElementById('exportBtn').onclick = exportJSON;

document.getElementById('searchBtn').onclick = ()=> {
  const q = document.getElementById('searchInput').value.trim().toLowerCase();
  if (!q) { renderTable(fullData); return; }
  const filtered = {};
  for (const h in fullData) {
    const e = fullData[h] || {};
    const hv = (e.hanviet || '').toLowerCase();
    const matchWords = (e.words || []).some(w => (w.chinese||'').includes(q) || (w.meaning||'').toLowerCase().includes(q));
    const matchSentences = (e.sentences || []).some(s => (s.chinese||'').includes(q) || (s.vietnamese||'').toLowerCase().includes(q));
    if (h.includes(q) || hv.includes(q) || matchWords || matchSentences) filtered[h] = e;
  }
  renderTable(filtered);
};
document.getElementById('resetSearchBtn').onclick = ()=> {
  document.getElementById('searchInput').value='';
  renderTable(fullData);
};

function clearForm() {
  document.getElementById('word-form').reset();
  wordsList.innerHTML = '';
  sentencesList.innerHTML = '';
  addInputRow(wordsList, 'word');
  addInputRow(sentencesList, 'sentence');
  const hanziInput = document.getElementById('hanzi');
  hanziInput.readOnly = false; // tr·ªü v·ªÅ ch·∫ø ƒë·ªô th√™m m·ªõi
}

function renderTable(data) {
  vocabTableBody.innerHTML = '';
  const keys = Object.keys(data).sort((a,b)=>a.localeCompare(b, 'zh-Hans-CN'));
  for (const hanzi of keys) {
    const entry = data[hanzi] || {};
    const wstr = (entry.words || []).map(w => w.chinese).join(', ');
    const isProtected = protectedKeys.has(hanzi);
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${hanzi}${isProtected ? ' <span class="pill">CSDL g·ªëc</span>' : ''}</td>
      <td>${entry.hanviet || ''}</td>
      <td>${wstr}</td>
      <td>
        <button type="button" onclick="editEntry('${hanzi.replace(/'/g, "\\'")}')">S·ª≠a</button>
        <button type="button" ${isProtected ? 'disabled title="Kh√¥ng th·ªÉ x√≥a m·ª•c thu·ªôc CSDL g·ªëc"' : ''}
          class="${isProtected ? 'muted' : 'danger'}" onclick="deleteEntry('${hanzi.replace(/'/g, "\\'")}')">X√≥a</button>
      </td>
    `;
    vocabTableBody.appendChild(tr);
  }
}

function editEntry(hanzi) {
  clearForm();
  const entry = fullData[hanzi] || {};
  const hanziInput = document.getElementById('hanzi');
  hanziInput.value = hanzi;
  hanziInput.readOnly = true; // ƒëang ·ªü ch·∫ø ƒë·ªô s·ª≠a
  document.getElementById('hanviet').value = entry.hanviet || '';
  (entry.words || []).forEach(w => {
    addInputRow(wordsList, 'word');
    const last = wordsList.lastElementChild;
    last.querySelector('.word-chinese').value = w.chinese || '';
    last.querySelector('.word-vietnamese').value = w.meaning || '';
    last.querySelector('.word-category').value = (w.category || []).join(', ');
  });
  (entry.sentences || []).forEach(s => {
    addInputRow(sentencesList, 'sentence');
    const last = sentencesList.lastElementChild;
    last.querySelector('.sentence-chinese').value = s.chinese || '';
    last.querySelector('.sentence-vietnamese').value = s.vietnamese || '';
    last.querySelector('.sentence-category').value = (s.category || []).join(', ');
  });
}

function deleteEntry(hanzi) {
  if (protectedKeys.has(hanzi)) {
    showMessage("‚ùå Kh√¥ng th·ªÉ x√≥a m·ª•c thu·ªôc CSDL g·ªëc", 'error');
    return;
  }
  if (!confirm("B·∫°n ch·∫Øc ch·∫Øn x√≥a '" + hanzi + "'?")) return;
  delete fullData[hanzi];
  localStorage.setItem('tuvung', JSON.stringify(fullData));
  renderTable(fullData);
  showMessage("üóëÔ∏è ƒê√£ x√≥a '" + hanzi + "'");
}

document.getElementById('word-form').addEventListener('submit', (e)=>{
  e.preventDefault();
  const hanzi = document.getElementById('hanzi').value.trim();
  if (!hanzi) { showMessage('‚ùå Ch·ªØ H√°n kh√¥ng ƒë∆∞·ª£c tr·ªëng', 'error'); return; }
  const hanviet = document.getElementById('hanviet').value.trim();
  const words = [...wordsList.querySelectorAll('.list-item')].map(row=>{
    const c = row.querySelector('.word-chinese').value.trim();
    const v = row.querySelector('.word-vietnamese').value.trim();
    const cat = row.querySelector('.word-category').value.split(',').map(s=>s.trim()).filter(Boolean);
    if (!c && !v) return null;
    return { chinese:c, meaning:v, category:cat };
  }).filter(Boolean);
  const sentences = [...sentencesList.querySelectorAll('.list-item')].map(row=>{
    const c = row.querySelector('.sentence-chinese').value.trim();
    const v = row.querySelector('.sentence-vietnamese').value.trim();
    const cat = row.querySelector('.sentence-category').value.split(',').map(s=>s.trim()).filter(Boolean);
    if (!c && !v) return null;
    return { chinese:c, vietnamese:v, category:cat };
  }).filter(Boolean);

  const isEditMode = document.getElementById('hanzi').readOnly;

  // ‚úÖ Ch·∫∑n th√™m tr√πng: n·∫øu ƒëang th√™m m·ªõi m√† ƒë√£ t·ªìn t·∫°i -> b√°o l·ªói
  if (!isEditMode && fullData[hanzi]) {
    showMessage("‚ö†Ô∏è T·ª´ '" + hanzi + "' ƒë√£ c√≥ trong c∆° s·ªü d·ªØ li·ªáu. H√£y b·∫•m 'S·ª≠a' n·∫øu mu·ªën c·∫≠p nh·∫≠t.", 'error');
    return;
  }

  fullData[hanzi] = { hanviet, words, sentences };
  localStorage.setItem('tuvung', JSON.stringify(fullData));
  renderTable(fullData);
  showMessage(isEditMode ? "‚úÖ ƒê√£ c·∫≠p nh·∫≠t" : "‚úÖ ƒê√£ th√™m m·ªõi");
  clearForm();
});

// ====== Import JSON t·ª´ file (KH√îNG MERGE) ======
document.getElementById('jsonFile').addEventListener('change', (e)=>{
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = () => {
    try {
      const json = JSON.parse(reader.result);
      fullData = json;
      // kh√≥a c√°c m·ª•c g·ªëc (kh√¥ng cho x√≥a)
      protectedKeys = new Set(Object.keys(fullData));
      saveProtectedToLS();
      localStorage.setItem('tuvung', JSON.stringify(fullData));
      renderTable(fullData);
      showMessage('‚úÖ ƒê√£ t·∫£i d·ªØ li·ªáu t·ª´ File. C√°c m·ª•c g·ªëc ƒë√£ ƒë∆∞·ª£c b·∫£o v·ªá kh·ªèi x√≥a.');
    } catch (err) {
      console.error(err);
      showMessage('‚ùå File JSON kh√¥ng h·ª£p l·ªá', 'error');
    }
  };
  reader.readAsText(file);
});

// ====== Import JSON t·ª´ URL (KH√îNG MERGE) ======
document.getElementById('loadUrlBtn').addEventListener('click', async ()=>{
  const url = document.getElementById('jsonUrl').value.trim();
  if (!url) { showMessage('‚ùå B·∫°n ch∆∞a nh·∫≠p URL', 'error'); return; }
  try {
    // cache-busting ƒë·ªÉ tr√°nh l·∫•y b·∫£n c≈©
    const bust = (url.includes('?') ? '&' : '?') + 't=' + Date.now();
    const res = await fetch(url + bust, { method: 'GET' });
    if (!res.ok) throw new Error(res.status + ' ' + res.statusText);
    const json = await res.json();
    fullData = json;
    // kh√≥a c√°c m·ª•c g·ªëc
    protectedKeys = new Set(Object.keys(fullData));
    saveProtectedToLS();
    localStorage.setItem('tuvung', JSON.stringify(fullData));
    renderTable(fullData);
    showMessage('‚úÖ ƒê√£ t·∫£i d·ªØ li·ªáu t·ª´ URL. C√°c m·ª•c g·ªëc ƒë√£ ƒë∆∞·ª£c b·∫£o v·ªá kh·ªèi x√≥a.');
  } catch (err) {
    console.error(err);
    // G·ª£i √Ω l·ªói CORS
    const hint = (err instanceof TypeError) ? ' (C√≥ th·ªÉ do CORS b·ªã ch·∫∑n. H√£y d√πng link GitHub Raw/Vercel/Netlify ho·∫∑c c·∫•u h√¨nh CORS.)' : '';
    showMessage('‚ùå L·ªói t·∫£i JSON t·ª´ URL: ' + err.message + hint, 'error');
  }
});

// ====== Xu·∫•t JSON ======
function exportJSON() {
  const blob = new Blob([JSON.stringify(fullData, null, 2)], { type: 'application/json' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'tuvung.json';
  a.click();
  URL.revokeObjectURL(a.href);
}

// ====== Kh·ªüi t·∫°o ======
(function init(){
  loadProtectedFromLS();
  const saved = localStorage.getItem('tuvung');
  if (saved) {
    try { fullData = JSON.parse(saved); }
    catch { fullData = {}; }
  }
  renderTable(fullData);
  clearForm();
})();
</script>
</body>
</html>
